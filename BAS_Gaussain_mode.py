import tensorflow as tf
import tensorflow_probability as tfp
import numpy as np
# import matplotlib.pyplot as plt
tfd = tfp.distributions


class Discrete_Gaussian:
    def __init__(self, batch_size=16, num_dataset=100000, n_bits=10):
        # 设置参数
        self.n_bits = n_bits
        self.x_max = 2 ** self.n_bits  #
        # self.x = np.arange(1, self.x_max + 1)  # 离散的x值
        self.batch_size = batch_size
        # 高斯分布参数
        self.nu = self.x_max / 8  # 标准差
        self.mu1 = (2 / 7) * self.x_max  # 第一个高斯分布的均值
        self.mu2 = (5 / 7) * self.x_max  # 第二个高斯分布的均值
        self.weights = [0.5, 0.5]
        self.probs = self.mixture_probs(self.x_max, self.mu1, self.nu, self.mu2, self.nu, self.weights)
        self.num_dataset = num_dataset
        self.dataset = self.sample_batch(self.num_dataset)

    # 自定义离散高斯分布
    def discrete_normal(self, loc, scale, size):
        """创建离散高斯分布，返回一个概率分布。
        :param loc: 均值
        :param scale: 标准差
        :param size: 离散范围的大小
        :return: 概率向量
        """
        x = tf.range(1, size + 1, dtype=tf.float32)  # 定义x的离散范围
        probs = tf.exp(-0.5 * ((x - loc) / scale) ** 2)  # 高斯分布概率密度
        probs /= tf.reduce_sum(probs)  # 归一化概率
        return probs

    def mixture_probs(self, size, loc1, scale1, loc2, scale2, weights):
        probs1 = self.discrete_normal(loc1, scale1, size)
        probs2 = self.discrete_normal(loc2, scale2, size)
        probs = weights[0] * probs1 + weights[1] * probs2
        return probs

    # 定义采样批次函数
    def sample_batch(self, batch_size):
        """
        从混合高斯模型中采样一批次的样本。
        :param batch_size: 批次大小
        :return: 采样的样本
        """
        probs_tensor = tf.convert_to_tensor(self.probs, dtype=tf.float32)
        categorical = tfd.Categorical(probs=probs_tensor)
        samples = categorical.sample(batch_size)
        return samples

    # 将样本转换为二进制数组
    def samples_to_binary_array(self, samples, n_bits):
        """
        将样本转换为固定长度的二进制数组。
        :param samples: 采样的样本（整数列表）
        :param n_bits: 二进制位数
        :return: np.array，维度(batch_size, n_bits)
        """
        # 将样本转换为固定长度的二进制字符串
        binary_strings = [format(sample, f'0{n_bits}b') for sample in samples]

        # 将二进制字符串转换为二维数组
        binary_array = np.array(
            [[int(bit) for bit in binary] for binary in binary_strings],
            dtype=np.int32
        )
        return binary_array

    def get_samples(self):
        shuffled_matrix = tf.random.shuffle(self.dataset)

        # 从打乱后的矩阵中选取一个批次的数据
        batch_samples = shuffled_matrix[:self.batch_size]
        binary_samples = self.samples_to_binary_array(batch_samples.numpy(), self.n_bits)
        return binary_samples

    def get_probs(self):
        return self.probs.numpy()


def kl_divergence(p, q):
    # 将p和q转换为numpy数组，以确保它们是ndarray对象
    p = np.array(p)
    q = np.array(q)

    # 过滤掉q中为零的元素，以防止除零错误
    q = np.clip(q, 1e-10, None)

    # 计算KL散度
    return np.sum(p * np.log(p / q))

BAS_2x2 = [
    # 水平条纹
    [[1, 1],
     [0, 0]],

    [[0, 0],
     [1, 1]],

    # 垂直条纹
    [[1, 0],
     [1, 0]],

    [[0, 1],
     [0, 1]],

    # 全部填充
    [[1, 1],
     [1, 1]],

    # 全部空白
    [[0, 0],
     [0, 0]],
]


# 总共14种情况
BAS_3x3 = [
    # 水平条纹
    [[1, 1, 1],
     [0, 0, 0],
     [0, 0, 0]],

    [[0, 0, 0],
     [1, 1, 1],
     [0, 0, 0]],

    [[0, 0, 0],
     [0, 0, 0],
     [1, 1, 1]],

    [[1, 1, 1],
     [1, 1, 1],
     [0, 0, 0]],

    [[0, 0, 0],
     [1, 1, 1],
     [1, 1, 1]],

    [[1, 1, 1],
     [0, 0, 0],
     [1, 1, 1]],
    # 垂直条纹
    [[1, 0, 0],
     [1, 0, 0],
     [1, 0, 0]],

    [[0, 1, 0],
     [0, 1, 0],
     [0, 1, 0]],

    [[0, 0, 1],
     [0, 0, 1],
     [0, 0, 1]],

    [[1, 1, 0],
     [1, 1, 0],
     [1, 1, 0]],

    [[0, 1, 1],
     [0, 1, 1],
     [0, 1, 1]],

    [[1, 0, 1],
     [1, 0, 1],
     [1, 0, 1]],

    # 全部填充
    [[1, 1, 1],
     [1, 1, 1],
     [1, 1, 1]],

    # 全部空白
    [[0, 0, 0],
     [0, 0, 0],
     [0, 0, 0]]
]

BAS_2x3 = [
    # 水平条纹
    [[1, 1, 1],
     [0, 0, 0]],

    [[0, 0, 0],
     [1, 1, 1]],


    # 垂直条纹
    [[1, 0, 0],
     [1, 0, 0]],

    [[0, 1, 0],
     [0, 1, 0]],

    [[0, 0, 1],
     [0, 0, 1]],

    [[1, 1, 0],
     [1, 1, 0]],

    [[0, 1, 1],
     [0, 1, 1]],

    [[1, 0, 1],
     [1, 0, 1]],

    # 全部填充
    [[1, 1, 1],
     [1, 1, 1]],

    # 全部空白
    [[0, 0, 0],
     [0, 0, 0]]
]

BAS_2x4 = [
    # 水平条纹
    [[1, 1, 1, 1],
     [0, 0, 0, 0]],

    [[0, 0, 0, 0],
     [1, 1, 1, 1]],

    # 垂直条纹
    [[1, 0, 0, 0],
     [1, 0, 0, 0]],

    [[0, 1, 0, 0],
     [0, 1, 0, 0]],

    [[0, 0, 1, 0],
     [0, 0, 1, 0]],

    [[0, 0, 0, 1],
     [0, 0, 0, 1]],

    [[1, 1, 0, 0],
     [1, 1, 0, 0]],

    [[1, 0, 1, 0],
     [1, 0, 1, 0]],

    [[1, 0, 0, 1],
     [1, 0, 0, 1]],

    [[0, 1, 1, 0],
     [0, 1, 1, 0]],

    [[0, 1, 0, 1],
     [0, 1, 0, 1]],

    [[0, 0, 1, 1],
     [0, 0, 1, 1]],

    [[1, 1, 1, 0],
     [1, 1, 1, 0]],

    [[1, 1, 0, 1],
     [1, 1, 0, 1]],

    [[1, 0, 1, 1],
     [1, 0, 1, 1]],

    [[0, 1, 1, 1],
     [0, 1, 1, 1]],

    # 全部填充
    [[1, 1, 1, 1],
     [1, 1, 1, 1]],

    # 全部空白
    [[0, 0, 0, 0],
     [0, 0, 0, 0]]
]

BAS_3x4 = [
    # 水平条纹
    [[1, 1, 1, 1],
     [0, 0, 0, 0],
     [0, 0, 0, 0]],

    [[0, 0, 0, 0],
     [1, 1, 1, 1],
     [0, 0, 0, 0]],

    [[0, 0, 0, 0],
     [0, 0, 0, 0],
     [1, 1, 1, 1]],

    [[1, 1, 1, 1],
     [1, 1, 1, 1],
     [0, 0, 0, 0]],

    [[0, 0, 0, 0],
     [1, 1, 1, 1],
     [1, 1, 1, 1]],

    [[1, 1, 1, 1],
     [0, 0, 0, 0],
     [1, 1, 1, 1]],

    # 垂直条纹
    [[1, 0, 0, 0],
     [1, 0, 0, 0],
     [1, 0, 0, 0]
     ],

    [[0, 1, 0, 0],
     [0, 1, 0, 0],
     [0, 1, 0, 0]],

    [[0, 0, 1, 0],
     [0, 0, 1, 0],
     [0, 0, 1, 0]],

    [[0, 0, 0, 1],
     [0, 0, 0, 1],
     [0, 0, 0, 1]],

    [[1, 1, 0, 0],
     [1, 1, 0, 0],
     [1, 1, 0, 0]],

    [[1, 0, 1, 0],
     [1, 0, 1, 0],
     [1, 0, 1, 0]],

    [[1, 0, 0, 1],
     [1, 0, 0, 1],
     [1, 0, 0, 1]],

    [[0, 1, 1, 0],
     [0, 1, 1, 0],
     [0, 1, 1, 0]],

    [[0, 1, 0, 1],
     [0, 1, 0, 1],
     [0, 1, 0, 1]],

    [[0, 0, 1, 1],
     [0, 0, 1, 1],
     [0, 0, 1, 1]],

    [[1, 1, 1, 0],
     [1, 1, 1, 0],
     [1, 1, 1, 0]],

    [[1, 1, 0, 1],
     [1, 1, 0, 1],
     [1, 1, 0, 1]],

    [[1, 0, 1, 1],
     [1, 0, 1, 1],
     [1, 0, 1, 1]],

    [[0, 1, 1, 1],
     [0, 1, 1, 1],
     [0, 1, 1, 1]],

    # 全部填充
    [[1, 1, 1, 1],
     [1, 1, 1, 1],
     [1, 1, 1, 1]],

    # 全部空白
    [[0, 0, 0, 0],
     [0, 0, 0, 0],
     [0, 0, 0, 0]]
]

BAS_2x5 = [
    # 水平条纹
    [[1, 1, 1, 1, 1],
     [0, 0, 0, 0, 0]],

    [[0, 0, 0, 0, 0],
     [1, 1, 1, 1, 1]],

    # 垂直条纹（单列，共5种）
    [[1, 0, 0, 0, 0],
     [1, 0, 0, 0, 0]],  # 第1列

    [[0, 1, 0, 0, 0],
     [0, 1, 0, 0, 0]],  # 第2列

    [[0, 0, 1, 0, 0],
     [0, 0, 1, 0, 0]],  # 第3列

    [[0, 0, 0, 1, 0],
     [0, 0, 0, 1, 0]],  # 第4列

    [[0, 0, 0, 0, 1],
     [0, 0, 0, 0, 1]],  # 第5列

    # 垂直条纹（双列，共10种）
    [[1, 1, 0, 0, 0],
     [1, 1, 0, 0, 0]],  # 1-2列
    #
    [[1, 0, 1, 0, 0],
     [1, 0, 1, 0, 0]],  # 1-3列

    [[1, 0, 0, 1, 0],
     [1, 0, 0, 1, 0]],  # 1-4列

    [[1, 0, 0, 0, 1],
     [1, 0, 0, 0, 1]],  # 1-5列

    [[0, 1, 1, 0, 0],
     [0, 1, 1, 0, 0]],  # 2-3列

    [[0, 1, 0, 1, 0],
     [0, 1, 0, 1, 0]],  # 2-4列

    [[0, 1, 0, 0, 1],
     [0, 1, 0, 0, 1]],  # 2-5列

    [[0, 0, 1, 1, 0],
     [0, 0, 1, 1, 0]],  # 3-4列

    [[0, 0, 1, 0, 1],
     [0, 0, 1, 0, 1]],  # 3-5列

    [[0, 0, 0, 1, 1],
     [0, 0, 0, 1, 1]],  # 4-5列

    # 垂直条纹（三列，共10种）
    [[1, 1, 1, 0, 0],
     [1, 1, 1, 0, 0]],  # 1-2-3列

    [[1, 1, 0, 1, 0],
     [1, 1, 0, 1, 0]],  # 1-2-4列

    [[1, 1, 0, 0, 1],
     [1, 1, 0, 0, 1]],  # 1-2-5列

    [[1, 0, 1, 1, 0],
     [1, 0, 1, 1, 0]],  # 1-3-4列

    [[1, 0, 1, 0, 1],
     [1, 0, 1, 0, 1]],  # 1-3-5列

    [[1, 0, 0, 1, 1],
     [1, 0, 0, 1, 1]],  # 1-4-5列

    [[0, 1, 1, 1, 0],
     [0, 1, 1, 1, 0]],  # 2-3-4列

    [[0, 1, 1, 0, 1],
     [0, 1, 1, 0, 1]],  # 2-3-5列

    [[0, 1, 0, 1, 1],
     [0, 1, 0, 1, 1]],  # 2-4-5列

    [[0, 0, 1, 1, 1],
     [0, 0, 1, 1, 1]],  # 3-4-5列

    # 垂直条纹（四列，共5种）
    [[1, 1, 1, 1, 0],
     [1, 1, 1, 1, 0]],  # 1-2-3-4列

    [[1, 1, 1, 0, 1],
     [1, 1, 1, 0, 1]],  # 1-2-3-5列

    [[1, 1, 0, 1, 1],
     [1, 1, 0, 1, 1]],  # 1-2-4-5列

    [[1, 0, 1, 1, 1],
     [1, 0, 1, 1, 1]],  # 1-3-4-5列

    [[0, 1, 1, 1, 1],
     [0, 1, 1, 1, 1]],  # 2-3-4-5列

    # 全填充
    [[1, 1, 1, 1, 1],
     [1, 1, 1, 1, 1]],

    # 全空白
    [[0, 0, 0, 0, 0],
     [0, 0, 0, 0, 0]]
]


BAS_4x4 = [
    # ---------- 水平条纹 ----------
    # 单行全1（4种）
    [[1,1,1,1], [0,0,0,0], [0,0,0,0], [0,0,0,0]],  # 1111000000000000 → 61440
    [[0,0,0,0], [1,1,1,1], [0,0,0,0], [0,0,0,0]],  # 0000111100000000 → 3840
    [[0,0,0,0], [0,0,0,0], [1,1,1,1], [0,0,0,0]],  # 0000000011110000 → 240
    [[0,0,0,0], [0,0,0,0], [0,0,0,0], [1,1,1,1]],  # 0000000000001111 → 15

    # 两行全1（6种）
    [[1,1,1,1], [1,1,1,1], [0,0,0,0], [0,0,0,0]],  # 1111111100000000 → 65280
    [[1,1,1,1], [0,0,0,0], [1,1,1,1], [0,0,0,0]],  # 1111000011110000 → 61680
    [[1,1,1,1], [0,0,0,0], [0,0,0,0], [1,1,1,1]],  # 1111000000001111 → 61455
    [[0,0,0,0], [1,1,1,1], [1,1,1,1], [0,0,0,0]],  # 0000111111110000 → 4080
    [[0,0,0,0], [1,1,1,1], [0,0,0,0], [1,1,1,1]],  # 0000111100001111 → 3855
    [[0,0,0,0], [0,0,0,0], [1,1,1,1], [1,1,1,1]],  # 0000000011111111 → 255

    # 三行全1（4种）
    [[1,1,1,1], [1,1,1,1], [1,1,1,1], [0,0,0,0]],  # 1111111111110000 → 65520
    [[1,1,1,1], [1,1,1,1], [0,0,0,0], [1,1,1,1]],  # 1111111100001111 → 65295
    [[1,1,1,1], [0,0,0,0], [1,1,1,1], [1,1,1,1]],  # 1111000011111111 → 61695
    [[0,0,0,0], [1,1,1,1], [1,1,1,1], [1,1,1,1]],  # 0000111111111111 → 4095

    # ---------- 垂直条纹 ----------
    # 单列全1（4种）
    [[1,0,0,0], [1,0,0,0], [1,0,0,0], [1,0,0,0]],  # 1000100010001000 → 34952
    [[0,1,0,0], [0,1,0,0], [0,1,0,0], [0,1,0,0]],  # 0100010001000100 → 17476
    [[0,0,1,0], [0,0,1,0], [0,0,1,0], [0,0,1,0]],  # 0010001000100010 → 8738
    [[0,0,0,1], [0,0,0,1], [0,0,0,1], [0,0,0,1]],  # 0001000100010001 → 4369

    # 双列全1（6种）
    [[1,1,0,0], [1,1,0,0], [1,1,0,0], [1,1,0,0]],  # 1100110011001100 → 52428
    [[1,0,1,0], [1,0,1,0], [1,0,1,0], [1,0,1,0]],  # 1010101010101010 → 43690
    [[1,0,0,1], [1,0,0,1], [1,0,0,1], [1,0,0,1]],  # 1001100110011001 → 39321
    [[0,1,1,0], [0,1,1,0], [0,1,1,0], [0,1,1,0]],  # 0110011001100110 → 26214
    [[0,1,0,1], [0,1,0,1], [0,1,0,1], [0,1,0,1]],  # 0101010101010101 → 21845
    [[0,0,1,1], [0,0,1,1], [0,0,1,1], [0,0,1,1]],  # 0011001100110011 → 13107

    # 三列全1（4种）
    [[1,1,1,0], [1,1,1,0], [1,1,1,0], [1,1,1,0]],  # 1110111011101110 → 61166
    [[1,1,0,1], [1,1,0,1], [1,1,0,1], [1,1,0,1]],  # 1101110111011101 → 57021
    [[1,0,1,1], [1,0,1,1], [1,0,1,1], [1,0,1,1]],  # 1011101110111011 → 48059
    [[0,1,1,1], [0,1,1,1], [0,1,1,1], [0,1,1,1]],  # 0111011101110111 → 30583

    # ---------- 全填充 & 全空白 ----------
    [[1,1,1,1], [1,1,1,1], [1,1,1,1], [1,1,1,1]],  # 1111111111111111 → 65535
    [[0,0,0,0], [0,0,0,0], [0,0,0,0], [0,0,0,0]]   # 0000000000000000 → 0
]



if __name__ == '__main__':
    from collections import Counter
    import matplotlib.pyplot as plt

    for n in [4, 6, 8, 9, 10]:


        gm = Discrete_Gaussian(32, num_dataset=50000, n_bits=n)
        prob = gm.get_probs()
        np.savetxt(f"target_distribution_{n}qubit.txt", prob)

    print("Probabilities:")
    print(gm.get_probs())
    # for i in range(1000):

        # print(gm.get_samples())
    # 采样数据并计算直方图
    num_samples = 10000
    d = 2 ** 8
    batch_samples = gm.sample_batch(num_samples)
    binary_samples = gm.samples_to_binary_array(batch_samples.numpy(), 8)
    decimal_values = [int(''.join(map(str, sample.flatten())), 2) for sample in binary_samples]
    # decimal_values = [int(''.join(map(str, sample.flatten())), 2) for sample in binary_samples]

    # 统计每个十进制数的频率
    frequency_count = Counter(decimal_values)

    # 确保统计0到15所有可能性的频率，即使有些没有出现
    all_possible_values = list(range(d))
    frequencies = [frequency_count.get(val, 0) / float(num_samples) for val in all_possible_values]
    frequencies_stand = gm.get_probs()
    print("kl=", kl_divergence(frequencies_stand, frequencies))
    # 绘图
    plt.figure(figsize=(10, 6))

    # 概率质量函数 (PMF) 曲线
    plt.bar(all_possible_values, frequencies_stand, alpha=0.8, width=1.5, label="target", color="skyblue")
    plt.bar(all_possible_values, frequencies, alpha=0.5, width=1.5, label="trained", color="orange")

    # 图形格式
    plt.margins(x=0.05)

    plt.xlabel('3x3 Binary Pattern (as Decimal)')
    plt.ylabel('Frequency')
    plt.title('Frequency of 3x3 Binary Patterns')
    plt.legend()
    plt.tight_layout()
    plt.show()
    print("kl=", kl_divergence(frequencies_stand, frequencies))
